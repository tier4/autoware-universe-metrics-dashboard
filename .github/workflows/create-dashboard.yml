name: Create dashboard

on:
  schedule:
    - cron: "0 19 * * 0" # run at 4 AM JST on Sundays
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

jobs:
  generate-report:
    runs-on: ubuntu-latest
    env:
      ARTIFACTS_DIR: data
      TARGET_REPO: "autowarefoundation/autoware.universe"
      REPOS_FILE: "build_depends.repos"
      ROS_DISTRO: "galactic"

    steps:
    # https://github.community/t/bug-strange-no-space-left-on-device-ioexceptions-on-github-runners/17616
    # - name: Free disk space
    #   run: |
    #     sudo apt-get -y --allow-remove-essential purge \
    #       aria2 ansible azure-cli shellcheck rpm xorriso zsync clang* dotnet-sdk* esl-erlang firefox g++-8 gfortran* \
    #       google* ghc* cabal-install* imagemagick libmagick* ant ant-optional kubectl libnginx* \
    #       mercurial mono-complete mysql-client libmysqlclient-dev mysql-server mssql-tools unixodbc-dev \
    #       yarn chrpath libssl-dev libxft-dev libfreetype6 libfreetype6-dev libfontconfig1 libfontconfig1-dev php*
    #     sudo apt-get -y autoremove
    #     sudo apt-get -y autoclean
    #     sudo rm -rf /usr/local/lib/android
    #     docker rmi $(docker image ls -aq)
    #     df -h

    - uses: ros-tooling/setup-ros@v0.2
      with:
        required-ros-distributions: ${{ env.ROS_DISTRO }}

    - uses: actions/checkout@v2
      with:
        repository: ${{ env.TARGET_REPO }}

    - uses: actions/checkout@v2
      with:
        path: metrics_config_dir

    - uses: actions/checkout@v2
      with:
        ref: data
        path: ${{ env.ARTIFACTS_DIR }}

    - name: List packages
      id: list_packages
      run: echo ::set-output name=package_list::$(colcon list --names-only | egrep -v "behavior_velocity_planner|freespace_planning_algorithms")

    - name: Retrieve default branch
      id: retrieve_branch
      run: echo ::set-output name=default_branch::$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')

    - name: Add TARGET_REPO to vcs file
      run: |
        cat >>${{ env.REPOS_FILE }} <<EOF
          src/${{ env.TARGET_REPO }}:
            type: git
            url: https://github.com/${{ env.TARGET_REPO }}.git
            version: ${{ steps.retrieve_branch.outputs.default_branch }}
        EOF

    - name: Build and test
      uses: ros-tooling/action-ros-ci@v0.2
      id: build_and_test
      with:
        package-name: ${{ steps.list_packages.outputs.package_list }}
        target-ros2-distro: ${{ env.ROS_DISTRO }}
        vcs-repo-file-url: ${{ env.REPOS_FILE }}
        colcon-extra-args: "--parallel-workers 2"
        extra-cmake-args: -DCMAKE_CXX_FLAGS="-fprofile-arcs -ftest-coverage -DCOVERAGE_RUN=1" -DCMAKE_C_FLAGS="-fprofile-arcs -ftest-coverage -DCOVERAGE_RUN=1" -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
        colcon-defaults: |
          {
            "build": {
              "mixin": ["coverage-gcc"]
            }
          }
        colcon-mixin-repository: https://raw.githubusercontent.com/colcon/colcon-mixin-repository/1ddb69bedfd1f04c2f000e95452f7c24a4d6176b/index.yaml

    - id: metrics-reporter
      uses: tier4/ros-metrics-reporter@v0.3
      with:
        artifacts-dir: ${{ env.ARTIFACTS_DIR }}
        target-dir: ${{ steps.build_and_test.outputs.ros-workspace-directory-name }}
        base-url: "https://tier4.github.io/autoware-universe-metrics-dashboard/"
        title: ${{ env.TARGET_REPO }}
        ros-distro: ${{ env.ROS_DISTRO }}
        CCN: "20"
        CCN-recommendation: "10"
        nloc: "200"
        nloc-recommendation: "50"
        arguments: "6"
        arguments-recommendation: "6"
        exclude: |
          "*/dependency_packages/*"
          "**/autoware_debug_tools/*"
          "**/autoware_localization_rviz_plugin/*"
          "**/autoware_perception_rviz_plugin/*"
          "**/autoware_planning_rviz_plugin/*"
          "**/autoware_rosbag_recorder/*"
          "**/autoware_vehicle_rviz_plugin/*"
          "**/autoware_version/*"
          "**/autoware_web_controller/*"
          "**/dummy_diag_publisher/*"
          "**/dummy_perception_publisher/*"
          "**/initial_pose_button_panel/*"
          "**/polar_grid/*"
        codechecker-skip-list: "metrics_config_dir/codechecker-skip-list.txt"
        target-repository: ${{ env.TARGET_REPO }}

    - name: Check results
      run: |
        sudo apt-get install -y tree
        tree -L 2 ${GITHUB_WORKSPACE}/public/
        du -h

    - name: Push artifacts
      if: ${{ github.ref == 'refs/heads/main' }}
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.REPO_TOKEN }}
        publish_dir: ${{ env.ARTIFACTS_DIR }}
        publish_branch: data

    - name: Archive static pages
      if: ${{ github.ref != 'refs/heads/main' }}
      uses: actions/upload-artifact@v2
      with:
        name: static-pages
        path: public

    - name: Deploy public to gh-pages (main branch only)
      if: ${{ github.ref == 'refs/heads/main' }}
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.REPO_TOKEN }}
        publish_dir: public
